# 代理配置指南

如果您在中国或需要通过代理访问 npm、GitHub 等资源,可以为 ClaudeKit 配置代理。

---

## 📋 配置方法

### 方式一:使用代理配置示例文件(推荐)

1. **查找代理示例文件**

   安装 ClaudeKit 后,会自动生成 `claude-settings.proxy-example.json` 文件:

   - 项目级安装: `项目根目录/claude-settings.proxy-example.json`
   - 全局安装: `~/.claude/claude-settings.proxy-example.json`

2. **查看示例内容**

   ```json
   {
     "hooks": {
       "UserPromptSubmit": [ ... ],
       "PostToolUse": [ ... ],
       "PreToolUse": [ ... ]
     },
     "env": {
       "HTTP_PROXY": "http://127.0.0.1:7897",
       "HTTPS_PROXY": "http://127.0.0.1:7897",
       "http_proxy": "http://127.0.0.1:7897",
       "https_proxy": "http://127.0.0.1:7897",
       "NO_PROXY": "localhost,127.0.0.1"
     }
   }
   ```

3. **修改代理端口**

   根据您的代理软件端口修改:

   - Clash: 通常是 `7890` 或 `7897`
   - V2rayN: 通常是 `10809`
   - 其他代理: 查看您的代理软件设置

   示例(Clash 默认端口):
   ```json
   "env": {
     "HTTP_PROXY": "http://127.0.0.1:7890",
     "HTTPS_PROXY": "http://127.0.0.1:7890",
     "http_proxy": "http://127.0.0.1:7890",
     "https_proxy": "http://127.0.0.1:7890",
     "NO_PROXY": "localhost,127.0.0.1"
   }
   ```

4. **合并到 Claude Code 设置**

   - 打开 Claude Code 设置 (Settings)
   - 找到 JSON 配置
   - 将修改后的 `env` 部分添加到配置中

### 方式二:手动添加 env 配置

直接在 Claude Code 设置的 JSON 中添加:

```json
{
  "hooks": {
    // ... 现有的 hooks 配置
  },
  "env": {
    "HTTP_PROXY": "http://127.0.0.1:7890",
    "HTTPS_PROXY": "http://127.0.0.1:7890",
    "http_proxy": "http://127.0.0.1:7890",
    "https_proxy": "http://127.0.0.1:7890",
    "NO_PROXY": "localhost,127.0.0.1"
  }
}
```

---

## 🔍 常见代理软件端口

| 代理软件 | 默认端口 | 备注 |
|---------|---------|------|
| Clash | 7890 | HTTP/HTTPS 代理 |
| Clash | 7897 | HTTP/HTTPS 代理(备用) |
| V2rayN | 10809 | Socks 代理需转 HTTP |
| Shadowsocks | 1080 | 需要本地 HTTP 代理转换 |
| Qv2ray | 8889 | 可配置 |

**注意**: 如果您的代理软件只提供 SOCKS 代理,需要启用本地 HTTP 代理转换功能。

---

## ✅ 验证代理配置

配置完成后,可以通过以下方式验证:

1. **测试网络连接**
   ```bash
   # 测试代理是否工作
   curl -x http://127.0.0.1:7890 https://www.google.com
   ```

2. **重启 Claude Code**

   配置生效需要重启 Claude Code

3. **观察 npm 安装**

   ClaudeKit 的 hooks 依赖 npm 包,如果配置正确,npm 安装会通过代理

---

## 🛠️ 故障排查

### 问题 1: Hook 执行失败

**症状**: 提示 "UserPromptSubmit hook error"

**检查**:
```bash
# 手动测试代理
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
npm --registry=https://registry.npmjs.org/ view tsx
```

**解决方法**:
- 确认代理软件正在运行
- 检查端口号是否正确
- 验证代理是否允许本地连接

### 问题 2: npm 安装仍然很慢

**可能原因**:
- 代理配置未生效
- 代理软件未启动

**解决方法**:
1. 检查 Claude Code 设置中的 `env` 配置
2. 重启 Claude Code
3. 确认代理软件正在运行并监听对应端口

### 问题 3: 部分资源无法访问

**解决方法**:

添加 npm 代理配置:
```bash
npm config set proxy http://127.0.0.1:7890
npm config set https-proxy http://127.0.0.1:7890
```

取消 npm 代理(不需要时):
```bash
npm config delete proxy
npm config delete https-proxy
```

---

## 💡 最佳实践

### 1. 按需启用代理

如果您不总是需要代理:

- **方式 A**: 准备两个配置文件
  - `claude-settings.json` - 无代理配置
  - `claude-settings-with-proxy.json` - 带代理配置
  - 根据需要切换

- **方式 B**: 使用环境变量
  在系统环境变量中设置,Claude Code 会自动使用

### 2. 代理软件推荐

- **macOS**: ClashX / Surge
- **Windows**: Clash for Windows / V2rayN
- **Linux**: Clash / Qv2ray

### 3. 仅代理国外流量

在代理软件中配置规则模式(Rule Mode):
- 国内网站直连
- 国外网站走代理
- 这样可以提高访问速度

---

## 🔐 安全提示

1. **不要提交代理配置到 Git**

   `claude-settings.json` 和 `claude-settings.proxy-example.json`
   已被添加到 `.gitignore`

2. **保护代理凭证**

   如果代理需要用户名密码:
   ```json
   "HTTP_PROXY": "http://username:password@127.0.0.1:7890"
   ```
   请妥善保管这些凭证

3. **定期更新代理软件**

   保持代理软件最新版本以获得最佳性能和安全性

---

## 📚 相关资源

- [Clash 配置指南](https://github.com/Dreamacro/clash/wiki)
- [npm 代理配置](https://docs.npmjs.com/cli/v8/using-npm/config#proxy)
- [Claude Code 设置说明](https://docs.claude.com)

---

## 🆘 获取帮助

如果配置代理后仍有问题:

1. 查看 [故障排查指南](../../.claude/hooks/TROUBLESHOOTING.md)
2. 运行诊断工具:
   ```bash
   cd .claude/hooks
   ./test-skill-triggers.sh "test"
   ```
3. 在 [GitHub Issues](https://github.com/zengwenliang416/ClaudeKit/issues) 提问

---

**提示**: 代理配置是可选的。如果您的网络环境可以正常访问 npm 和 GitHub,无需配置代理。
